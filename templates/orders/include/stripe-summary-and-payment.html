{% load static %}

<div class="summary-and-payment-contents" id="sap">
  <ul>
    <!-- Personal informations -->
    <li class="summary-personal-infos">
      <ul>
        <li class="p-infos">Personal informations</li>
        <li class="p-email">{{order.email}}</li>
      </ul>
    </li>
    <!-- End Personal informations -->
    <!-- Shipping information -->
    <li class="shipping-container">
      <ul>
        <li class="shipping">
          <ul>
            <li class="sh-detail">shipping details</li>
            <li class="sh-upadate">uptate shipping details</li>
          </ul>
        </li>
        <li class="fullname">{{order.first_name}} {{order.last_name}}</li>
        <li class="fulladress">
          <ul>
            <li>{{order.address_line_1}} - {{order.postcode}}</li>
            <li>{{order.country}}</li>
            <li>{{order.zip_code}}{{order.phone}}</li>
          </ul>
        </li>
      </ul>
    </li>
    <!-- End Shipping information -->
    <!-- Delivery method -->
    <li class="delivery-method">
      <ul>
        <li class="delivery-method-title">Delivery method</li>
        <li class="method-price">
          <ul>
            <li class="the-method">
              {% if order.delivery_method == 'Colissimo' %} Colissimo ( Delivery
              within 2-4 days ) {% elif order.delivery_method == 'DHL' %} DHL (
              Delivery within 2-4 days ) {% else %} No delivery method selected
              {% endif %}
            </li>
            <li class="method-price">0 Eur</li>
          </ul>
        </li>
      </ul>
    </li>
    <!-- End delivery method -->
    <!-- Start Billing address -->
    <li class="billing-address">
      <ul>
        <li class="billing-title">
          <ul>
            <li class="bill-addr">Billing Address</li>
            <li class="bill-update">Update billing address</li>
          </ul>
        </li>
        <li class="address-note">
          <select name="" id="">
            <option value="">
              {{order.first_name}} {{order.last_name}},
              {{order.address_line_1}}, {{order.city}}, {{order.postcode}}
            </option>
          </select>
        </li>
      </ul>
    </li>
    <!-- End Billing address -->
    <!-- start of payments methods -->
    <li class="summary-payment-method">
      <ul>
        <li class="summary-payment-title">Payment methods</li>

        {% if order.payment_method == 'Card' %}
        <!-- Credit card -->
        <li class="one-payment-method">
          <input
            name="first_name"
            type="hidden"
            class="w-full p-5 rounded-xl"
            value="{{order.first_name}}"
          />
          <input
            name="last_name"
            type="hidden"
            class="w-full p-5 rounded-xl"
            value="{{order.last_name}}"
          />
          <input
            name="city"
            type="hidden"
            class="w-full p-5 rounded-xl"
            value="{{order.city}}"
          />
          <input
            name="country"
            type="hidden"
            class="w-full p-5 rounded-xl"
            value="{{order.country}}"
          />
          <input
            name="phone"
            type="hidden"
            class="w-full p-5 rounded-xl"
            value="{{order.phone}}"
          />
          <input
            name="address_line_1"
            type="hidden"
            class="w-full p-5 rounded-xl"
            value="{{order.address_line_1}}"
          />
          <input
            name="address_line_2"
            type="hidden"
            class="w-full p-5 rounded-xl"
            value="{{order.address_line_2}}"
          />
          <input
            name="zip_code"
            type="hidden"
            class="w-full p-5 rounded-xl"
            value="{{order.zip_code}}"
          />
          <input
            name="postcode"
            type="hidden"
            class="w-full p-5 rounded-xl"
            value="{{order.postcode}}"
          />
          <input
            name="payment_method"
            type="hidden"
            class="w-full p-5 rounded-xl"
            value="{{order.payment_method}}"
          />
          <input
            name="delivery_method"
            type="hidden"
            class="w-full p-5 rounded-xl"
            value="{{order.delivery_method}}"
          />
          <input
            name="order_number"
            type="hidden"
            class="w-full p-5 rounded-xl"
            value="{{order.dorder_number}}"
          />

            <button class="button is-primary stripe_payment_button" id="submitBtn">
              <img src="{% static 'assets/imgs/credit-card.png' %}" alt="">
                <h4>Payer</h4>
           
            </button>

         
          <!-- <button
            onclick="buy(event)"
            class="inline-block px-8 py-4 rounded-xl bg-red-600 hover:bg-red-700 text-white"
          >
            Pay now
          </button> -->
        </li>
        <li>
          <div class="mb-6 p-6 bg-gray-100 rounded-xl" id="errors"></div>
        </li>
        <!-- End credit card -->
      </ul>
    </li>
    <!-- End of payments methods -->
    {% else %} No payment method selected {% endif %}
  </ul>
</div>

{% block scripts %}
<script type="application/javascript" src="https://js.stripe.com/v3/"></script>
<script>

  console.log("Sanity check!");
  
  // Get Stripe publishable key
  fetch("{% url 'config' %}")
  .then((result) => { return result.json(); })
  .then((data) => {
    // Debug: Print out the fetched publishable key
    console.log("Fetched Publishable Key:", data.publicKey);
  
    // Initialize Stripe.js
    const stripe = Stripe(data.publicKey); // Ensure this key corresponds to the correct mode
  
    // Event handler
    document.querySelector("#submitBtn").addEventListener("click", () => {
      // Get Checkout Session ID
      fetch("{% url 'stripe_payment' %}")
      .then((result) => { return result.json(); })
      .then((data) => {
        console.log("Fetched Session ID:", data.sessionId); // Debug: Print out the fetched Session ID
        // Redirect to Stripe Checkout
        return stripe.redirectToCheckout({sessionId: data.sessionId})
      })
      .then((res) => {
        console.log("Redirect Result:", res); // Debug: Print out the redirection result
      })
      .catch((error) => {
        console.error("Error:", error); // Catch and log any errors during the process
      });
    });
  })
  .catch((error) => {
    console.error("Fetch Error:", error); // Catch and log any errors during the fetch operation
  });
  
  </script>

<!-- <script>
  let el = document.querySelector("#errors");

  function validateForm(data) {
    let errors = [];

    if (data.first_name === "") {
      errors.push("First name is empty");
    }
    if (data.last_name === "") {
      errors.push("Last name is empty");
    }
    if (data.email === "") {
      errors.push("Email is empty");
    }
    if (data.phone === "") {
      errors.push("Phone is empty");
    }
    if (data.address_line_1 === "") {
      errors.push("Address is empty");
    }
    if (data.zip_code === "") {
      errors.push("Zipcode is empty");
    }
    if (data.postcode === "") {
      errors.push("Zipcode is empty");
    }
    if (data.country === "") {
      errors.push("Country is empty");
    }
    if (data.city === "") {
      errors.push("City is empty");
    }
    if (data.delivery_method === "") {
      errors.push("Delivery_method is empty");
    }
    if (data.payment_method === "") {
      errors.push("Payment_method is empty");
    }

    if (errors.length > 0) {
      let html = "<ul>";
      errors.forEach((error) => {
        html += "<li>" + error + "</li>";
      });

      el.innerHTML = html + "</ul>";
    } else {
      el.innerHTML = "";
    }

    return errors;
  }

  var amount = "{{grand_total}}";
  amount = amount.replace(",", ".");
  console.log(amount);
  var orderID = "{{ order.order_number }}";
  var first_name = "{{ order.first_name }}";
  var last_name = "{{ order.last_name }}";
  var email = "{{ order.email }}";
  var phone = "{{ order.phone }}";
  var address_line_1 = "{{ order.address_line_1 }}";
  var address_line_2 = "{{ order.address_line_2 }}";
  var zip_code = "{{ order.zip_code }}";
  var postcode = "{{ order.postcode }}";
  var country = "{{ order.country }}";
  var payment_method = "{{ order.payment_method }}";
  var delivery_method = "{{ order.delivery_method }}";
  var order_number = "{{ order.order_number }}";
  var city = "{{ order.city }}";
  var status = "{{ order.status }}";
  var tax = "{{ order.tax }}";
  var order_total = "{{ order.order_total }}";
  console.log(orderID);
  var payment_method = "PayPal";
  var url = "{% url 'paypal_payment' %}";
  var redirect_url = "{% url 'order_complete' %}";


  function buy(event) {
    event.preventDefault();

    let data = {
      first_name: document.querySelector("input[name=first_name]").value,
      last_name: document.querySelector("input[name=last_name]").value,
      email: document.querySelector("input[name=email]").value,
      phone: document.querySelector("input[name=phone]").value,
      address_line_1: document.querySelector("input[name=address_line_1]")
        .value,
      address_line_2: document.querySelector("input[name=address_line_2]")
        .value,
      zip_code: document.querySelector("input[name=zip_code]").value,
      postcode: document.querySelector("input[name=postcode]").value,
      country: document.querySelector("input[name=country]").value,
      payment_method: document.querySelector("input[name=payment_method]")
        .value,
      delivery_method: document.querySelector("input[name=delivery_method]")
        .value,
      order_number: document.querySelector("input[name=order_number]").value,
    };
    console.log(data.first_name);
    console.log(data.phone);
    console.log(data.postcode);
    console.log(data.zip_code);
    console.log(data.payment_method);
    console.log(data.delivery_method);
    let errors = validateForm(data);

    if (errors.length) {
      console.log("Errors", errors);
    } else {
      var stripe = Stripe("{{ pub_key }}");

      fetch('{% url "stripe_payment" %}', {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        credentials: "same-origin",
        body: JSON.stringify({
          orderID: orderID,
          payment_method: payment_method,
          status: status,
          first_name:first_name,
          last_name:last_name,
          order_number:order_number,
          payment_method:payment_method,
          postcode:postcode,
          zip_code:zip_code,
          address_line_1:address_line_1,
          address_line_2:address_line_2,
          email:email,
          phone:phone,
          country:country,
          city:city,
          order_total:order_total,
          tax:tax

        }),
      })
        .then(function (response) {
          return response.json();
        })
        .then(function (session) {
          return stripe.redirectToCheckout({ sessionId: session.session.id });
        })
        .then(function (result) {
          if (result.error) {
            alert(result.error.messsage);
          }
        })
        .catch(function (error) {
          console.log("Errors", error);
        });
    }
    return false;
  }
</script> -->

{% endblock %}
